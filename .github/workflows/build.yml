name: Build Infinity-X for Spaced

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Crave and Build
        run: |
          # 1. Install Crave binary
          curl -s https://raw.githubusercontent.com/accupara/crave/master/get_crave.sh | bash -s --
          sudo install -m 0755 crave /usr/local/bin
          
          # 2. Setup crave.conf in the CURRENT directory
          # We remove the "base64:" prefix if it exists in your token to be safe
          CLEAN_TOKEN=$(echo "${{ secrets.CRAVE_TOKEN }}" | sed 's/base64://g')
          echo "{ \"username\": \"${{ secrets.CRAVE_USERNAME }}\", \"token\": \"$CLEAN_TOKEN\" }" > ./crave.conf
          
          # 3. Start the build using the -c flag to point directly to the config
          crave -c ./crave.conf run -- "
            repo init -u https://github.com/ProjectInfinity-X/manifest -b 14 --git-lfs ;
            # Clone your repo to get the spaced.xml manifest
            git clone https://github.com/daizeuz-dred/Test-Builds .repo/local_manifests ;
            repo sync -c -j\$(nproc --all) --force-sync --no-clone-bundle --no-tags ;
            source build/envsetup.sh ;
            lunch infinity_spaced-userdebug ;
            mka bacon
          "
