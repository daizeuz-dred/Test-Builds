name: Build Infinity-X for Spaced

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Crave and Build
        run: |
          # 1. Install Crave binary
          curl -s https://raw.githubusercontent.com/accupara/crave/master/get_crave.sh | bash -s --
          sudo install -m 0755 crave /usr/local/bin
          
          # 2. Setup credentials properly
          mkdir -p ~/.crave
          # Use your Secrets to create the config file in the home directory
          echo '{ "username": "${{ secrets.CRAVE_USERNAME }}", "token": "${{ secrets.CRAVE_TOKEN }}" }' > ~/.crave/crave.conf
          
          # 3. Run with the project flag
          # Using 'crave run' without the 'devspace' command can sometimes trigger socket errors
          # if the project isn't specified.
          crave run --project foss -- "
            repo init -u https://github.com/ProjectInfinity-X/manifest -b 14 --git-lfs ;
            git clone https://github.com/daizeuz-dred/Test-Builds .repo/local_manifests ;
            repo sync -c -j\$(nproc --all) --force-sync --no-clone-bundle --no-tags ;
            source build/envsetup.sh ;
            lunch infinity_spaced-userdebug ;
            mka bacon
          "
